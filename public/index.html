<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>Magnum Coins Farm</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9731351' data-sdk='show_9731351'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1f2c51 0%, #2a3a6b 25%, #1a1a2e 50%, #16213e 75%, #000000 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 0;
            overflow: hidden;
            margin: 0;
        }

        .balance-block {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            border-radius: 18px;
            padding: 20px;
            width: 400px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
            margin: 30px auto;
        }

        .balance-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .balance-block:hover::before {
            transform: translateX(100%);
        }

        .balance-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            display: block;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .balance-icon {
            font-size: 20px;
            margin-bottom: 10px;
            display: block;
        }

        .balance-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }

        .energy-bar-container {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .energy-bar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .energy-icon {
            font-size: 16px;
            filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.6));
        }

        .energy-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 6px;
        }

        .energy-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF6B35);
            border-radius: 4px;
            transition: width 0.5s ease-out;
            position: relative;
            will-change: width;
        }

        .energy-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: energyShine 2s infinite;
        }

        @keyframes energyShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .buttons-grid button {
            width: 100%;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .buttons-grid button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .buttons-grid button svg {
            width: 18px;
            height: 18px;
            transition: .3s ease;
        }
        
        .upgrade-btn {
            background: linear-gradient(15deg, #880088, #aa2068, #cc3f47, #de6f3d, #f09f33, #de6f3d, #cc3f47, #aa2068, #880088) no-repeat;
            background-size: 300%;
            color: #fff;
            background-position: left center;
        }

        .upgrade-btn:hover {
            background-size: 320%;
            background-position: right center;
        }

        .upgrade-btn svg {
            fill: #f09f33;
        }

        .upgrade-btn:hover svg {
            fill: #fff;
        }
        
        .tasks-btn {
            background: linear-gradient(15deg, #4CAF50, #45a049, #2E7D32, #1B5E20, #0D4F14, #1B5E20, #2E7D32, #45a049, #4CAF50) no-repeat;
            background-size: 300%;
            color: #fff;
            background-position: left center;
        }

        .tasks-btn:hover {
            background-size: 320%;
            background-position: right center;
        }

        .tasks-btn svg {
            fill: #90EE90;
        }

        .tasks-btn:hover svg {
            fill: #fff;
        }
        
        .achievements-btn {
            background: linear-gradient(15deg, #FF6B6B, #ee5a24, #ff8c42, #ffa726, #ffcc02, #ffa726, #ff8c42, #ee5a24, #FF6B6B) no-repeat;
            background-size: 300%;
            color: #fff;
            background-position: left center;
        }

        .achievements-btn:hover {
            background-size: 320%;
            background-position: right center;
        }

        .achievements-btn svg {
            fill: #ffcc02;
        }

        .achievements-btn:hover svg {
            fill: #fff;
        }
        
        .leaderboard-btn {
            background: linear-gradient(15deg, #9C27B0, #673AB7, #3F51B5, #2196F3, #00BCD4, #2196F3, #3F51B5, #673AB7, #9C27B0) no-repeat;
            background-size: 300%;
            color: #fff;
            background-position: left center;
        }

        .leaderboard-btn:hover {
            background-size: 320%;
            background-position: right center;
        }

        .leaderboard-btn svg {
            fill: #00BCD4;
        }

        .leaderboard-btn:hover svg {
            fill: #fff;
        }

        .top-panel {
            position: fixed;
            top: 0;
            right: 0;
            padding: 15px 20px;
            z-index: 999;
        }

        .main-content {
            margin-top: 20px;
            padding: 20px;
            background: transparent;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }

        /* Окно загрузки */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: -webkit-linear-gradient(90deg, #ccb6b6,#000000,#000000);
            background: linear-gradient(90deg, #ccb6b6,#000000,#000000);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .loading-text {
            font-size: 1.1rem;
            opacity: 0.8;
            text-align: center;
            margin-top: 20px;
        }

        /* Анимированная загрузка */
        .loader {
            --path: #fff;
            --dot: #ff6b6b;
            --duration: 3s;
            width: 44px;
            height: 44px;
            position: relative;
        }

        .loader:before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            position: absolute;
            display: block;
            background: var(--dot);
            top: 37px;
            left: 19px;
            transform: translate(-18px, -18px);
            animation: dotRect var(--duration) cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .loader svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .loader svg rect, .loader svg polygon, .loader svg circle {
            fill: none;
            stroke: var(--path);
            stroke-width: 10px;
            stroke-linejoin: round;
            stroke-linecap: round;
        }

        .loader svg polygon {
            stroke-dasharray: 145 76 145 76;
            stroke-dashoffset: 0;
            animation: pathTriangle var(--duration) cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .loader svg rect {
            stroke-dasharray: 192 64 192 64;
            stroke-dashoffset: 0;
            animation: pathRect 3s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .loader svg circle {
            stroke-dasharray: 150 50 150 50;
            stroke-dashoffset: 75;
            animation: pathCircle var(--duration) cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .loader.triangle {
            width: 48px;
        }

        .loader.triangle:before {
            left: 21px;
            transform: translate(-10px, -18px);
            animation: dotTriangle var(--duration) cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .loader {
            display: inline-block;
            margin: 0 16px;
        }

        @keyframes pathTriangle {
            33% {
                stroke-dashoffset: 74;
            }

            66% {
                stroke-dashoffset: 147;
            }

            100% {
                stroke-dashoffset: 221;
            }
        }

        @keyframes dotTriangle {
            33% {
                transform: translate(0, 0);
            }

            66% {
                transform: translate(10px, -18px);
            }

            100% {
                transform: translate(-10px, -18px);
            }
        }

        @keyframes pathRect {
            25% {
                stroke-dashoffset: 64;
            }

            50% {
                stroke-dashoffset: 128;
            }

            75% {
                stroke-dashoffset: 192;
            }

            100% {
                stroke-dashoffset: 256;
            }
        }

        @keyframes dotRect {
            25% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(18px, -18px);
            }

            75% {
                transform: translate(0, -36px);
            }

            100% {
                transform: translate(-18px, -18px);
            }
        }

        @keyframes pathCircle {
            25% {
                stroke-dashoffset: 125;
            }

            50% {
                stroke-dashoffset: 175;
            }

            75% {
                stroke-dashoffset: 225;
            }

            100% {
                stroke-dashoffset: 275;
            }
        }



        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
            animation: fadeIn 0.8s ease-out;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }



        /* ============ CONFIG ============ */
        .magnum-coin{
          --coin-size: 200px;                 /* общий размер монеты */
          --gold-1: #fef4c6;                  /* свет */
          --gold-2: #ffd675;                  /* средний свет */
          --gold-3: #ffb43b;                  /* базовое золото */
          --gold-4: #d88a20;                  /* тени */
          --gold-5: #7a4b13;                  /* глубокие тени */
          --specular: rgba(255,255,255,.55);  /* блик */
          --shadow: rgba(0,0,0,.35);          /* тень от монеты */

          --lava-1: #ff3b0a;
          --lava-2: #ff7a00;
          --lava-3: #ffd200;
          --lava-glow: rgba(255, 77, 0, .35);

          --rim-width: 12px;                  /* ширина канта */
          --bevel: 14px;                      /* "фаска" */
          --logo-emboss: 10px;                /* глубина рельефа буквы M */
          --shine-speed: 4s;                  /* скорость пробега блика */
          --lava-speed: 6s;                   /* скорость "течения" лавы */
        }

        /* ============ RESET ============ */
        .magnum-coin{
          -webkit-tap-highlight-color: transparent;
          appearance: none; border: 0; background: transparent; padding: 0;
          cursor: pointer; outline: none;
        }

        /* ============ COIN WRAPPER ============ */
        .magnum-coin{
          width: var(--coin-size);
          height: var(--coin-size);
          border-radius: 50%;
          display: inline-grid;
          place-items: center;
          transform: translateZ(0); /* включаем композитинг */
          filter: drop-shadow(0 10px 18px var(--shadow));
          transition: transform .08s ease, filter .2s ease;
          margin: 20px 0;
        }
        .magnum-coin:active{
          transform: translateY(2px) scale(.985);
          filter: drop-shadow(0 6px 12px var(--shadow));
        }

        /* ============ COIN FACE ============ */
        .magnum-coin__face{
          position: relative;
          width: 100%; height: 100%;
          border-radius: 50%;
          overflow: hidden;
          /* главный золотой градиент */
          background:
            radial-gradient(120% 120% at 30% 30%, var(--gold-1) 0 18%, var(--gold-2) 30%, var(--gold-3) 55%, var(--gold-4) 75%, var(--gold-5) 100%);
          box-shadow:
            inset 0 2px 4px rgba(255,255,255,.25),
            inset 0 -10px 18px rgba(0,0,0,.25),
            0 0 0 1px rgba(255,255,255,.1);
        }

        /* ============ RIM (КАНТ) ============ */
        .magnum-coin__rim{
          content: "";
          position: absolute; inset: 0;
          border-radius: 50%;
          padding: var(--rim-width);
          background:
            radial-gradient(circle at 50% 50%, transparent calc(100% - var(--rim-width)), rgba(0,0,0,.25) calc(100% - var(--rim-width) + 1px));
          -webkit-mask:
            radial-gradient(circle, #000 62%, transparent 63%); /* "выкусить" центр */
                mask:
            radial-gradient(circle, #000 62%, transparent 63%);
          pointer-events: none;
        }

        /* насечки на канте (микро) */
        .magnum-coin__rim::after{
          content:"";
          position:absolute; inset: 4%;
          border-radius: 50%;
          background:
            conic-gradient(from 0deg,
              rgba(255,255,255,.08) 0 2deg, transparent 2deg 6deg) ;
          -webkit-mask: radial-gradient(circle, transparent 0 66%, #000 67%);
                  mask: radial-gradient(circle, transparent 0 66%, #000 67%);
          filter: blur(.4px);
          opacity:.55;
        }

        /* ============ INNER (ВНУТРЕННЕЕ ПОЛЕ) ============ */
        .magnum-coin__inner{
          content:"";
          position:absolute; inset: calc(var(--rim-width) + 3px);
          border-radius: 50%;
          background:
            linear-gradient(145deg, rgba(255,255,255,.25), rgba(0,0,0,.15)) border-box,
            radial-gradient(120% 120% at 70% 70%, var(--gold-2), var(--gold-3) 40%, var(--gold-4) 75%) padding-box;
          box-shadow:
            inset 0 6px 12px rgba(255,255,255,.18),
            inset 0 -12px 20px rgba(0,0,0,.28);
        }

        /* декоративные концентрические кольца */
        .magnum-coin__inner::after{
          content:"";
          position:absolute; inset: 10%;
          border-radius: 50%;
          background:
            radial-gradient(closest-side, transparent calc(100% - 1px), rgba(255,255,255,.22) calc(100% - 0px)) ,
            radial-gradient(closest-side, transparent calc(100% - 12px), rgba(0,0,0,.18) calc(100% - 11px));
          opacity:.6;
        }

        /* ============ LOGO (M) ============ */
        .magnum-coin__logo{
          position:absolute; inset: 0;
          display:grid; place-items:center;
          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Inter', Arial, sans-serif;
          font-weight: 800;
          letter-spacing: .02em;
          font-size: calc(var(--coin-size) * .36);
          color: transparent;
          /* Рельефный текст через градиенты и тени */
          background:
            linear-gradient(180deg, #fff 0%, #ffe9a8 35%, #f2b54d 60%, #7a4b13 100%);
          -webkit-background-clip: text;
                  background-clip: text;
          text-shadow:
            0 1px 0 rgba(255,255,255,.7),
            0 2px 0 rgba(255,255,255,.35),
            0 3px 0 rgba(255,255,255,.2),
            0 4px 6px rgba(0,0,0,.4);

          /* Вдавленность */
          filter:
            drop-shadow(0 2px 0 rgba(0,0,0,.25))
            drop-shadow(0 6px var(--logo-emboss) rgba(0,0,0,.2));
          pointer-events:none;
        }

        /* ============ SPECULAR SHINE (ПРОБЕГАЮЩИЙ БЛИК) ============ */
        .magnum-coin__shine{
          content:"";
          position:absolute; inset:-30%;
          background:
            conic-gradient(from 0deg, transparent 0 70%, rgba(255,255,255,.7) 74%, transparent 80% 100%);
          animation: sweep var(--shine-speed) linear infinite;
          mix-blend-mode: screen;
          opacity:.6; pointer-events:none;
          border-radius:50%;
          filter: blur(10px);
        }

        @keyframes sweep {
          0%   { transform: rotate(0deg)   scale(1.05); }
          100% { transform: rotate(360deg) scale(1.05); }
        }

        /* ============ LAVA GLOW (МИНИ "МАГМА") ============ */
        .magnum-coin__lava{
          content:"";
          position:absolute; inset: 2%;
          border-radius:50%;
          background:
            radial-gradient(120% 100% at 75% 85%, var(--lava-1), transparent 55%),
            radial-gradient(120% 100% at 25% 20%, var(--lava-2), transparent 55%),
            radial-gradient(100% 80%  at 50% 100%, var(--lava-3), transparent 45%);
          mix-blend-mode: overlay;
          filter: blur(12px) saturate(1.2);
          opacity:.22;
          animation: lavaFlow var(--lava-speed) ease-in-out infinite alternate;
          pointer-events:none;
        }

        @keyframes lavaFlow{
          0%  { transform: translate(-2px, 0) scale(1.0); opacity:.18; }
          50% { transform: translate(2px, 1px) scale(1.02); opacity:.28; }
          100%{ transform: translate(-1px, -1px) scale(1.01); opacity:.22; }
        }

        /* Ховер-эффекты */
        @media (hover:hover){
          .magnum-coin:hover .magnum-coin__lava{ opacity:.3; }
          .magnum-coin:hover{ filter: drop-shadow(0 14px 22px var(--shadow)); }
        }

        /* Поддержка тёмных страниц (необязательно) */
        @media (prefers-color-scheme: dark){
          .magnum-coin{ filter: drop-shadow(0 14px 22px rgba(0,0,0,.55)); }
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }
            
            .magnum-coin {
                --coin-size: 150px;
            }
            
            .balance {
                font-size: 2.5rem;
            }
        }

        /* Кнопка настроек */
        .setting-btn {
            width: 42px;
            height: 42px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: linear-gradient(135deg, rgba(129, 110, 216, 0.9), rgba(102, 126, 234, 0.9));
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(129, 110, 216, 0.4);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .setting-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(129, 110, 216, 0.6);
            background: linear-gradient(135deg, rgba(129, 110, 216, 1), rgba(102, 126, 234, 1));
        }

        .bar {
            width: 50%;
            height: 2px;
            background-color: rgb(229, 229, 229);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 2px;
        }

        .bar::before {
            content: "";
            width: 2px;
            height: 2px;
            background-color: rgb(126, 117, 255);
            position: absolute;
            border-radius: 50%;
            border: 2px solid white;
            transition: all 0.3s;
            box-shadow: 0px 0px 5px white;
        }

        .bar1::before {
            transform: translateX(-4px);
        }

        .bar2::before {
            transform: translateX(4px);
        }

        .setting-btn:hover .bar1::before {
            transform: translateX(4px);
        }

        .setting-btn:hover .bar2::before {
            transform: translateX(-4px);
        }



        /* Новая панель кнопок */
        .menu {
            padding: 0.5rem;
            background: -webkit-linear-gradient(90deg,#ec7513,#cc1414,#340548,#1a1820);
            background: linear-gradient(90deg,#ec7513,#cc1414,#340548,#1a1820);
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            border-radius: 15px;
            box-shadow: 0 10px 25px 0 rgba(0, 0, 0, 0.075);
            z-index: 1000;
        }

        .link {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 70px;
            height: 50px;
            border-radius: 8px;
            position: relative;
            z-index: 1;
            overflow: hidden;
            transform-origin: center left;
            transition: width 0.2s ease-in;
            text-decoration: none;
            color: white;
        }

        .link:before {
            position: absolute;
            z-index: -1;
            content: "";
            display: block;
            border-radius: 8px;
            width: 100%;
            height: 100%;
            top: 0;
            transform: translateX(100%);
            transition: transform 0.2s ease-in;
            transform-origin: center right;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .link:hover,
        .link:focus {
            outline: 0;
            width: 130px;
        }

        .link:hover:before,
        .link:focus:before,
        .link:hover .link-title,
        .link:focus .link-title {
            transform: translateX(0);
            opacity: 1;
        }

        .link-icon {
            width: 28px;
            height: 28px;
            display: block;
            flex-shrink: 0;
            left: 18px;
            position: absolute;
        }

        .link-icon svg {
            width: 28px;
            height: 28px;
        }

        .link-title {
            transform: translateX(100%);
            transition: transform 0.2s ease-in;
            transform-origin: center right;
            display: block;
            text-align: center;
            text-indent: 28px;
            width: 100%;
            font-size: 12px;
            font-weight: bold;
        }



        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .ad-modal {
            max-width: 600px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 18px 18px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header h2 {
            margin: 0;
            color: white;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Задания */
        .task-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .task-info h3 {
            margin: 0 0 10px 0;
            color: white;
            font-size: 1.2rem;
        }

        .task-info p {
            margin: 0 0 10px 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .reward {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .task-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .task-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .task-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Адаптивность для мобильных */
        @media (max-width: 480px) {
            .button-container {
                width: 320px;
                height: 55px;
                bottom: 20px;
            }
            
            .button {
                width: 50px;
                height: 42px;
                font-size: 8px;
            }
            
            .button-text {
                font-size: 7px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .task-item {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .task-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>


    <!-- Окно загрузки -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-title">Magnum Coins</div>
        
        <div style="display: flex; align-items: center; justify-content: center; margin: 20px 0;">
            <div class="loader">
                <svg viewBox="0 0 80 80">
                    <circle r="32" cy="40" cx="40" id="test"></circle>
                </svg>
            </div>

            <div class="loader triangle">
                <svg viewBox="0 0 86 80">
                    <polygon points="43 8 79 72 7 72"></polygon>
                </svg>
            </div>

            <div class="loader">
                <svg viewBox="0 0 80 80">
                    <rect height="64" width="64" y="8" x="8"></rect>
                </svg>
            </div>
        </div>
        
        <div class="loading-text" id="loadingText">Загрузка...</div>
    </div>

    <!-- Кнопка настроек в правом верхнем углу -->
    <div class="top-panel">
        <button class="setting-btn" id="settingsBtn">
            <span class="bar bar1"></span>
            <span class="bar bar2"></span>
            <span class="bar bar1"></span>
        </button>
    </div>

    <div class="main-content">
        <div class="container">
            <button class="magnum-coin" id="clickButton" aria-label="Magnum Coin">
                <span class="magnum-coin__face">
                    <span class="magnum-coin__rim"></span>
                    <span class="magnum-coin__inner"></span>
                    <span class="magnum-coin__logo">M</span>
                    <span class="magnum-coin__shine"></span>
                    <span class="magnum-coin__lava"></span>
                </span>
            </button>
            
            <!-- Блок баланса под монетой -->
            <div class="balance-block">
                <span class="balance-label">Баланс</span>
                <div class="balance-amount" id="coins">0</div>
                <div class="balance-subtitle">Magnum Coins</div>
                
                <!-- Новая шкала энергии -->
                <div class="energy-bar-container">
                    <div class="energy-bar-header">
                        <span class="energy-icon">⚡</span>
                        <span>Энергия</span>
                    </div>
                    <div class="energy-text" id="energyText">400/1000</div>
                    <div class="energy-bar">
                        <div class="energy-fill" id="energyFill" style="width: 40%"></div>
                    </div>
                </div>
                
                <!-- Сетка кнопок 2x2 -->
                <div class="buttons-grid">
                    <button class="upgrade-btn" id="upgradeBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                        </svg>
                        Улучшения
                    </button>
                    <button class="achievements-btn" id="achievementsBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Достижения
                    </button>
                    <button class="tasks-btn" id="tasksBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        Задания
                    </button>
                    <button class="leaderboard-btn" id="leaderboardBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.5 21H2V9h5.5v12zm7.25-18h-3.5v18h3.5V3zM22 11h-5.5v10H22V11z"/>
                        </svg>
                        Лидеры
                    </button>
                </div>
            </div>
            

        </div>
    </div>

    <!-- Новая панель кнопок -->
    <div class="menu">
        <a href="#" class="link" id="shopBtn" data-action="shop">
            <span class="link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256">
                    <rect width="256" height="256" fill="none"></rect>
                    <path d="M184,184H69.81818L41.92162,30.56892A8,8,0,0,0,34.05066,24H16" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <circle cx="80" cy="216" r="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></circle>
                    <circle cx="184" cy="216" r="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></circle>
                    <path d="M62.54543,144H188.10132a16,16,0,0,0,15.74192-13.1018L216,64H48" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                </svg>
            </span>
            <span class="link-title">Магазин</span>
        </a>
        <a href="#" class="link" id="exchangeBtn" data-action="exchange">
            <span class="link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256">
                    <rect width="256" height="256" fill="none"></rect>
                    <path d="M32,184V72a8,8,0,0,1,8-8H216a8,8,0,0,1,8,8V184" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <path d="M32,184H216v32a8,8,0,0,1-8,8H40a8,8,0,0,1-8-8Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <path d="M80,144V104" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <path d="M112,144V88" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <path d="M144,144V120" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <path d="M176,144V72" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                </svg>
            </span>
            <span class="link-title">Биржа</span>
        </a>

        <a href="#" class="link" id="walletBtn" data-action="wallet">
            <span class="link-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256">
                    <rect width="256" height="256" fill="none"></rect>
                    <path d="M184,72H24a8,8,0,0,0-8,8V176a8,8,0,0,0,8,8H184a8,8,0,0,0,8-8V80A8,8,0,0,0,184,72Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <path d="M184,88H32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
                    <circle cx="104" cy="128" r="16" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></circle>
                </svg>
            </span>
            <span class="link-title">Кошелек</span>
        </a>
    </div>

    

    <!-- Модальное окно рекламы -->
    <div id="adModal" class="modal" style="display: none;">
        <div class="modal-content ad-modal">
            <div class="modal-header">
                <h2>📺 Реклама</h2>
                <span class="close" id="closeAdModal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="adContainer" style="width: 100%; height: 300px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 10px; margin: 10px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📺</div>
                        <div>Загрузка рекламы...</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div id="adTimer" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">Ожидание: 30 сек</div>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">Не закрывайте это окно до завершения рекламы</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Функция загрузки
        function showLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingText = document.getElementById('loadingText');
            
            const loadingSteps = [
                { text: 'Инициализация...' },
                { text: 'Загрузка данных...' },
                { text: 'Подготовка игры...' },
                { text: 'Почти готово...' },
                { text: 'Готово!' }
            ];

            let currentStep = 0;

            function updateLoading() {
                if (currentStep < loadingSteps.length) {
                    const step = loadingSteps[currentStep];
                    loadingText.textContent = step.text;
                    currentStep++;
                    
                    setTimeout(updateLoading, 1000);
                } else {
                    // Загрузка завершена
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }, 500);
                }
            }

            updateLoading();
        }

        // Игровые данные
        let gameData = {
            coins: 0,
            clicks: 0,
            coinsPerClick: 1,
            energy: 1000, // Начальный баланс энергии
            maxEnergy: 1000, // Максимальный баланс энергии
            tasksCompleted: 0,
            adsWatched: 0,
            lastAdWatch: 0
        };

        // Данные улучшений
        let upgrades = {
            speedUpgrade: { purchased: false, price: 100, effect: 'Ускоряет анимацию клика' },
            coinMultiplier: { purchased: false, price: 500, effect: 'Удваивает доход за клик' },
            autoClicker: { purchased: false, price: 1000, effect: 'Автоматически кликает каждые 5 сек' }
        };

        // Достижения
        let achievements = {
            firstClick: { unlocked: false, progress: 0, target: 1, reward: 10, icon: '👆', title: 'Первый клик', description: 'Сделайте свой первый клик' },
            clickMaster: { unlocked: false, progress: 0, target: 100, reward: 50, icon: '⚡', title: 'Мастер кликов', description: 'Сделайте 100 кликов' },
            clickPro: { unlocked: false, progress: 0, target: 1000, reward: 200, icon: '🔥', title: 'Про-кликер', description: 'Сделайте 1000 кликов' },
            coinCollector: { unlocked: false, progress: 0, target: 1000, reward: 100, icon: '💰', title: 'Коллекционер монет', description: 'Накопите 1000 монет' },
            coinMillionaire: { unlocked: false, progress: 0, target: 10000, reward: 500, icon: '💎', title: 'Миллионер', description: 'Накопите 10000 монет' },
            adWatcher: { unlocked: false, progress: 0, target: 5, reward: 150, icon: '📺', title: 'Любитель рекламы', description: 'Посмотрите 5 реклам' },
            taskMaster: { unlocked: false, progress: 0, target: 10, reward: 300, icon: '✅', title: 'Мастер заданий', description: 'Выполните 10 заданий' },
            allRounder: { unlocked: false, progress: 0, target: 7, reward: 1000, icon: '🌟', title: 'Универсал', description: 'Разблокируйте все остальные достижения' }
        };

        // Автокликер
        let autoClickerInterval = null;

        // Настройки игры
        let gameSettings = {
            sound: true,
            vibration: true,
            animations: true,
            animationSpeed: 5,
            coinsPerClick: 1
        };

        // Настройки рекламы Monetag
        const AD_CONFIG = {
            zoneId: '9731351', // Zone ID от Monetag
            rewardAmount: 50,
            cooldownMinutes: 5, // Кулдаун между просмотрами рекламы в минутах
            adDuration: 30 // Длительность рекламы в секундах
        };

        // Переменные для рекламы
        let adTimer = null;
        let adStartTime = null;
        let isAdPlaying = false;

        // Загружаем сохраненные данные
        function loadGameData() {
            try {
                const saved = localStorage.getItem('magnumCoinsData');
                if (saved) {
                    const loadedData = JSON.parse(saved);
                    // Объединяем с дефолтными значениями для новых полей
                    gameData = {
                        coins: loadedData.coins || 0,
                        clicks: loadedData.clicks || 0,
                        coinsPerClick: loadedData.coinsPerClick || 1,
                        energy: loadedData.energy || 1000,
                        maxEnergy: loadedData.maxEnergy || 1000,
                        tasksCompleted: loadedData.tasksCompleted || 0,
                        adsWatched: loadedData.adsWatched || 0,
                        lastAdWatch: loadedData.lastAdWatch || 0
                    };
                    updateDisplay();
                }
                
                // Загружаем настройки
                const savedSettings = localStorage.getItem('magnumSettings');
                if (savedSettings) {
                    gameSettings = JSON.parse(savedSettings);
                }
                
                // Загружаем улучшения
                const savedUpgrades = localStorage.getItem('magnumUpgrades');
                if (savedUpgrades) {
                    upgrades = JSON.parse(savedUpgrades);
                    applyUpgrades();
                }
                
                // Загружаем достижения
                const savedAchievements = localStorage.getItem('magnumAchievements');
                if (savedAchievements) {
                    achievements = JSON.parse(savedAchievements);
                }
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
                // Используем дефолтные значения при ошибке
                gameData = {
                    coins: 0,
                    clicks: 0,
                    coinsPerClick: 1,
                    energy: 1000,
                    maxEnergy: 1000,
                    tasksCompleted: 0,
                    adsWatched: 0,
                    lastAdWatch: 0
                };
                updateDisplay();
            }
        }

        // Сохраняем данные
        function saveGameData() {
            localStorage.setItem('magnumCoinsData', JSON.stringify(gameData));
            localStorage.setItem('magnumSettings', JSON.stringify(gameSettings));
            localStorage.setItem('magnumUpgrades', JSON.stringify(upgrades));
            localStorage.setItem('magnumAchievements', JSON.stringify(achievements));
        }

        // Обновляем отображение
        function updateDisplay() {
            try {
                const coinsElement = document.getElementById('coins');
                const energyTextElement = document.getElementById('energyText');
                const energyFillElement = document.getElementById('energyFill');
                
                if (coinsElement) coinsElement.textContent = gameData.coins.toLocaleString();
                
                // Обновляем новую шкалу энергии
                if (energyTextElement && energyFillElement) {
                    const energyPercent = (gameData.energy / gameData.maxEnergy) * 100;
                    energyTextElement.textContent = `${gameData.energy.toLocaleString()}/${gameData.maxEnergy.toLocaleString()}`;
                    energyFillElement.style.width = `${energyPercent}%`;
                }
            } catch (error) {
                console.error('Ошибка при обновлении отображения:', error);
            }
        }

        // Оптимизированное обновление только энергии (без мерцания)
        function updateEnergyDisplay() {
            try {
                const energyTextElement = document.getElementById('energyText');
                const energyFillElement = document.getElementById('energyFill');
                
                if (energyTextElement && energyFillElement) {
                    const energyPercent = (gameData.energy / gameData.maxEnergy) * 100;
                    
                    // Обновляем текст только если он изменился
                    const newText = `${gameData.energy.toLocaleString()}/${gameData.maxEnergy.toLocaleString()}`;
                    if (energyTextElement.textContent !== newText) {
                        energyTextElement.textContent = newText;
                    }
                    
                    // Обновляем ширину только если она изменилась
                    const newWidth = `${energyPercent}%`;
                    if (energyFillElement.style.width !== newWidth) {
                        energyFillElement.style.width = newWidth;
                    }
                }
            } catch (error) {
                console.error('Ошибка при обновлении энергии:', error);
            }
        }



        // Обработчик клика
        function handleClick() {
            try {
                // Проверяем, есть ли энергия для клика
                if (!gameData || gameData.energy <= 0) {
                    if (gameSettings.vibration && navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                    return;
                }
                
                gameData.coins += gameSettings.coinsPerClick;
                gameData.clicks++;
                gameData.energy--; // Тратим 1 энергию за клик
                
                // Анимация монеты уже встроена в CSS
                
                updateDisplay(); // Обновляем все (монеты и энергию)
                checkAchievements();
                saveGameData();
                
                // Вибрация (если включена и поддерживается)
                if (gameSettings.vibration && navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } catch (error) {
                console.error('Ошибка при обработке клика:', error);
            }
        }

        // Обработчик кнопки настроек
        function handleSettings() {
            // Вибрация (если включена и поддерживается)
            if (gameSettings.vibration && navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            
            // Переходим на страницу настроек
            window.location.href = '/settings.html';
        }
        
        // Обработчик кнопки улучшений
        function handleUpgrade() {
            // Вибрация (если включена и поддерживается)
            if (gameSettings.vibration && navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            
            // Переходим на страницу улучшений
            window.location.href = '/upgrades.html';
        }
        
        // Обработчик кнопки заданий
        function handleTasks() {
            // Вибрация (если включена и поддерживается)
            if (gameSettings.vibration && navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            
            // Переходим на страницу заданий
            window.location.href = '/tasks.html';
        }

        // Функции магазина
        function openShop() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            sessionStorage.setItem('returningFromPage', 'true');
            window.location.href = '/shop.html';
        }

        function buyUpgrade(upgradeType) {
            const upgrade = upgrades[upgradeType];
            
            if (gameData.coins >= upgrade.price && !upgrade.purchased) {
                gameData.coins -= upgrade.price;
                upgrade.purchased = true;
                
                // Применяем эффект улучшения
                applyUpgrade(upgradeType);
                
                // Обновляем отображение
                updateDisplay();
                saveGameData();
                

                
                // Вибрация (без всплывающих сообщений)
                if (gameSettings.vibration && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            } else if (upgrade.purchased) {
                // Тихий отказ без alert
                if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(20);
            } else {
                // Недостаточно монет — без alert
                if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            }
        }

        function applyUpgrade(upgradeType) {
            switch(upgradeType) {
                case 'speedUpgrade':
                    // Ускоряем анимацию
                    break;
                case 'coinMultiplier':
                    // Удваиваем доход
                    gameSettings.coinsPerClick *= 2;
                    break;
                case 'autoClicker':
                    // Запускаем автокликер
                    startAutoClicker();
                    break;
            }
        }

        function applyUpgrades() {
            if (upgrades.coinMultiplier.purchased) {
                gameSettings.coinsPerClick *= 2;
            }
            if (upgrades.autoClicker.purchased) {
                startAutoClicker();
            }
        }

        function startAutoClicker() {
            if (autoClickerInterval) {
                clearInterval(autoClickerInterval);
            }
            autoClickerInterval = setInterval(() => {
                handleClick();
            }, 5000);
        }

        // Обработчики кнопок панели
        function handleShop() {
            openShop();
        }

        function handleExchange() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            
            // Переходим на страницу биржи
            sessionStorage.setItem('returningFromPage', 'true');
            window.location.href = '/exchange.html';
        }



        function handleAchievements() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            // Переходим на страницу достижений
            window.location.href = '/achievements.html';
        }

        function handleLeaderboard() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            // Переходим на страницу лидеров
            window.location.href = '/leaderboard.html';
        }

        function handleHelp() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            // Без alert
            // Помощь скрыта для оптимизации
        }

        // Функции для заданий
        function openTasksPage() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            // Переходим на страницу заданий
            window.location.href = '/tasks.html';
        }
        
        // Функции для кошелька
        function openWalletPage() {
            if (gameSettings.vibration && navigator.vibrate) navigator.vibrate(30);
            // Устанавливаем флаг возврата
            sessionStorage.setItem('returningFromPage', 'true');
            // Переходим на страницу кошелька
            window.location.href = '/wallet.html';
        }

        function openAdModal() {
            document.getElementById('adModal').style.display = 'block';
            startAdTimer();
        }

        function closeAdModal() {
            document.getElementById('adModal').style.display = 'none';
            if (adTimer) {
                clearInterval(adTimer);
                adTimer = null;
            }
            isAdPlaying = false;
        }

        function startAdTimer() {
            isAdPlaying = true;
            adStartTime = Date.now();
            
            const timerElement = document.getElementById('adTimer');
            const adContainer = document.getElementById('adContainer');
            
            // Показываем загрузку рекламы
            adContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">📺</div>
                    <div>Загрузка рекламы...</div>
                </div>
            `;
            
            // Обновляем таймер
            timerElement.textContent = 'Загрузка рекламы...';
            
            // Запускаем рекламу через небольшую задержку
            setTimeout(() => {
                loadMonetagAd();
            }, 1000);
        }

        function loadMonetagAd() {
            const adContainer = document.getElementById('adContainer');
            
            // Интеграция с Monetag (PropellerAds)
            if (typeof window.show_9731351 !== 'undefined') {
                try {
                    window.show_9731351().then(() => {
                        completeAdWatch();
                    }).catch((error) => {
                        console.error('❌ Ошибка рекламы:', error);
                        showAdError();
                    });
                } catch (error) {
                    console.error('❌ Ошибка при показе рекламы:', error);
                    showAdError();
                }
            } else {
                // Демо-реклама для тестирования
                showDemoAd();
            }
        }

        function showDemoAd() {
            const adContainer = document.getElementById('adContainer');
            adContainer.innerHTML = `
                <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #ff6b6b, #ee5a24); display: flex; align-items: center; justify-content: center; border-radius: 10px;">
                    <div style="text-align: center; color: white;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📺</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">Демо-реклама</div>
                        <div style="font-size: 14px; opacity: 0.8;">Это демонстрационная реклама</div>
                        <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">В реальном приложении здесь будет реклама от Monetag</div>
                    </div>
                </div>
            `;
        }

        function showAdError() {
            const adContainer = document.getElementById('adContainer');
            adContainer.innerHTML = `
                <div style="text-align: center; color: #ff6b6b;">
                    <div style="font-size: 48px; margin-bottom: 10px;">❌</div>
                    <div>Ошибка загрузки рекламы</div>
                    <div style="font-size: 12px; margin-top: 10px;">Попробуйте позже</div>
                </div>
            `;
            
            setTimeout(() => {
                closeAdModal();
            }, 3000);
        }

        function completeAdWatch() {
            if (!isAdPlaying) return;
            
            isAdPlaying = false;
            
            // Начисляем награду
            gameData.coins += AD_CONFIG.rewardAmount;
            gameData.adsWatched++;
            gameData.tasksCompleted++;
            gameData.lastAdWatch = Date.now();
            
            // Обновляем отображение
            updateDisplay();
            saveGameData();
            
            // Показываем уведомление о награде
            const adContainer = document.getElementById('adContainer');
            const timerElement = document.getElementById('adTimer');
            
            adContainer.innerHTML = `
                <div style="text-align: center; color: #4CAF50;">
                    <div style="font-size: 48px; margin-bottom: 10px;">🎉</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Реклама завершена!</div>
                    <div style="font-size: 16px; color: #ffd700;">+${AD_CONFIG.rewardAmount} монет</div>
                </div>
            `;
            
            timerElement.textContent = 'Награда получена!';
            timerElement.style.color = '#4CAF50';
            
            // Вибрация
            if (gameSettings.vibration && navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 100]);
            }
            
            // Закрываем модальное окно через 3 секунды
            setTimeout(() => {
                closeAdModal();
                closeTasksModal();
            }, 3000);
        }

        function canWatchAd() {
            const now = Date.now();
            const cooldownMs = AD_CONFIG.cooldownMinutes * 60 * 1000;
            
            // Проверяем, что lastAdWatch существует и является числом
            if (!gameData.lastAdWatch || typeof gameData.lastAdWatch !== 'number') {
                return true; // Если нет времени последнего просмотра, можно смотреть
            }
            
            return (now - gameData.lastAdWatch) >= cooldownMs;
        }

        function handleWatchAd() {
            if (!canWatchAd()) {
                const now = Date.now();
                const cooldownMs = AD_CONFIG.cooldownMinutes * 60 * 1000;
                
                // Безопасный расчет оставшегося времени
                let remainingTime = 0;
                if (gameData.lastAdWatch && typeof gameData.lastAdWatch === 'number') {
                    remainingTime = Math.ceil((cooldownMs - (now - gameData.lastAdWatch)) / 1000 / 60);
                    remainingTime = Math.max(0, remainingTime); // Не меньше 0
                }
                
                if (remainingTime > 0) {
                    // Без alert
                    console.log(`⏰ Подождите еще ${remainingTime} минут перед следующим просмотром рекламы`);
                    return;
                }
            }
            
            openAdModal();
        }



        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            // Проверяем загрузку SDK Monetag
            setTimeout(() => {
                if (typeof window.show_9731351 === 'undefined') {
                    console.warn('⚠️ SDK Monetag не загружен!');
                }
            }, 2000);
            
            // Проверяем, возвращаемся ли мы с другой страницы
            const isReturning = sessionStorage.getItem('returningFromPage');
            
            if (!isReturning) {
                // Запускаем загрузку только при первом входе
                showLoading();
            } else {
                // Скрываем экран загрузки сразу при возврате
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                // Очищаем флаг возврата
                sessionStorage.removeItem('returningFromPage');
            }
            
            // Загружаем данные игры
            loadGameData();
            

            
            // Привязываем обработчик клика
            const clickButton = document.getElementById('clickButton');
            if (clickButton) {
                clickButton.addEventListener('click', handleClick);
            }
            
            // Привязываем обработчик настроек
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', handleSettings);
            }
            
            // Привязываем обработчик кнопки улучшений
            const upgradeBtn = document.getElementById('upgradeBtn');
            if (upgradeBtn) {
                upgradeBtn.addEventListener('click', handleUpgrade);
            }
            
            // Привязываем обработчик кнопки заданий
            const tasksBtn = document.getElementById('tasksBtn');
            if (tasksBtn) {
                tasksBtn.addEventListener('click', handleTasks);
            }
            
            // Привязываем обработчик кнопки достижений
            const achievementsBtn = document.getElementById('achievementsBtn');
            if (achievementsBtn) {
                achievementsBtn.addEventListener('click', handleAchievements);
            }
            
            // Привязываем обработчик кнопки лидеров
            const leaderboardBtn = document.getElementById('leaderboardBtn');
            if (leaderboardBtn) {
                leaderboardBtn.addEventListener('click', handleLeaderboard);
            }
            
            // Обработчики кнопок панели
            document.querySelectorAll('.link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const action = link.getAttribute('data-action');
                    switch(action) {
                        case 'shop':
                            handleShop();
                            break;
                        case 'exchange':
                            handleExchange();
                            break;
                        case 'achievements':
                            handleAchievements();
                            break;
                        case 'leaderboard':
                            handleLeaderboard();
                            break;
                        case 'wallet':
                            openWalletPage();
                            break;
                    }
                });
            });

                         // Обработчики модального окна рекламы
             const closeAdModal = document.getElementById('closeAdModal');
             if (closeAdModal) {
                 closeAdModal.addEventListener('click', closeAdModal);
             }

             // Закрытие модального окна рекламы при клике вне его
             window.addEventListener('click', (event) => {
                 const adModal = document.getElementById('adModal');
                 
                 if (event.target === adModal) {
                     closeAdModal();
                 }
             });
            
            // Автосохранение каждые 5 секунд
            setInterval(saveGameData, 5000);
            
            // Восстановление энергии каждые 5 секунд
            setInterval(restoreEnergy, 5000);
            
            // Проверяем достижения при загрузке
            checkAchievements();
            
            // Инициализация завершена
        });

        // Восстановление энергии
        function restoreEnergy() {
            try {
                if (gameData && gameData.energy < gameData.maxEnergy) {
                    gameData.energy++;
                    updateEnergyDisplay(); // Используем оптимизированную функцию
                }
            } catch (error) {
                console.error('Ошибка при восстановлении энергии:', error);
            }
        }

        // Функции достижений
        function checkAchievements() {
            // Первый клик
            if (gameData.clicks >= 1 && !achievements.firstClick.unlocked) {
                unlockAchievement('firstClick');
            }
            
            // Мастер кликов
            if (gameData.clicks >= 100 && !achievements.clickMaster.unlocked) {
                unlockAchievement('clickMaster');
            }
            
            // Про-кликер
            if (gameData.clicks >= 1000 && !achievements.clickPro.unlocked) {
                unlockAchievement('clickPro');
            }
            
            // Коллекционер монет
            if (gameData.coins >= 1000 && !achievements.coinCollector.unlocked) {
                unlockAchievement('coinCollector');
            }
            
            // Миллионер
            if (gameData.coins >= 10000 && !achievements.coinMillionaire.unlocked) {
                unlockAchievement('coinMillionaire');
            }
            
            // Любитель рекламы
            if (gameData.adsWatched >= 5 && !achievements.adWatcher.unlocked) {
                unlockAchievement('adWatcher');
            }
            
            // Мастер заданий
            if (gameData.tasksCompleted >= 10 && !achievements.taskMaster.unlocked) {
                unlockAchievement('taskMaster');
            }
            
            // Универсал (все остальные достижения)
            const otherAchievements = Object.values(achievements).filter(a => a.title !== 'Универсал');
            const unlockedOthers = otherAchievements.filter(a => a.unlocked).length;
            if (unlockedOthers >= 7 && !achievements.allRounder.unlocked) {
                unlockAchievement('allRounder');
            }
        }

        function unlockAchievement(achievementKey) {
            const achievement = achievements[achievementKey];
            achievement.unlocked = true;
            achievement.progress = achievement.target;
            
            // Начисляем награду
            gameData.coins += achievement.reward;
            
            // Обновляем отображение
            updateDisplay();
            // Без всплывающих уведомлений
        }

        // Удаляем функцию showAchievementNotification и связанные стили уведомлений
    </script>
</body>
</html>

